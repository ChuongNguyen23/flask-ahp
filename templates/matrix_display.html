<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- meta data -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font-family -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,300,400,500,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Rufina:400,700" rel="stylesheet">
  
  <title>CarVilla</title>

  <!-- favicon -->
  <link rel="shortcut icon" type="image/icon" href="{{ url_for('static', filename='assets/logo/favicon.png') }}"/>
 
  <!-- core CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/font-awesome.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/linearicons.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/flaticon.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/animate.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/owl.carousel.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/owl.theme.default.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootsnav.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/responsive.css') }}">

  <!-- FontAwesome (load after flaticon.css) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/flaticon.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

<style>
/* Đẩy toàn bộ nội dung xuống tránh dính header (navbar cao ~70px) */
body {
    padding-top: 120px;
  }

  /* Tạo khoảng cách trước section chính */
  .card.shadow-sm {
    margin-top: 20px;
    margin-bottom: 40px;
  }

  /* Căn giữa và tăng khoảng cách cho nút tính toán */
  .card-body form .btn {
    margin-top: 20px;
    margin-bottom: 20px;
  }

  /* Khoảng cách giữa form và chart */
  .chart-container {
    margin-top: 50px;
  }

  /* Nếu bạn dùng .container.my-5 thì đã có padding, nhưng đảm bảo chart cũng có padding */
  .chart-container h5 {
    margin-bottom: 20px;
  }

  /* Navbar giữ nguyên */
.navbar-default {
  background-color: #000 !important;
  border-color: #000 !important;
}
.navbar-default .navbar-brand,
.navbar-default .navbar-nav>li>a {
  color: #fff !important;
}

.text-center{
  margin-top: 20px;
}

/* Font chung cho toàn trang (nếu muốn) */
body, .table, .btn, .chart-container {
  font-family: 'Poppins', sans-serif;
}

/* Cỡ chữ cho tiêu đề biểu đồ */
.chart-container h5 {
  font-size: 2.75rem;   /* ví dụ 28px */
}

/* Cỡ chữ mặc định cho legend và ticks (Chart.js canvas) */
canvas {
  /* đảm bảo canvas không bị co cụm */
  max-width: 100%;
}

 /* Ẩn feedback mặc định */
  .invalid-feedback {
    display: none;
  }
  /* Khi input có is-invalid, feedback ngay sau nó hiện lên */
  .form-control.is-invalid + .invalid-feedback {
    display: block;
  }
    /* Ẩn feedback mặc định */
  .invalid-feedback {
    display: none;
  }
  /* Khi input có is-invalid, feedback ngay sau nó hiện lên */
  .form-control.is-invalid + .invalid-feedback {
    display: block;
  }
</style>
</head>
	
<body>
  <!-- Navigation (giữ nguyên) -->
  <section id="home2" class="welcome-2hero">
    <div class="top-area">
      <div class="header-area">
        <nav class="navbar navbar-default bootsnav navbar-sticky navbar-scrollspy" 
             data-minus-value-desktop="70" data-minus-value-mobile="55" data-speed="1000">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
                <i class="fa fa-bars"></i>
              </button>
              <a class="navbar-brand" href="{{ url_for('index') }}">AHP Auto Advisor</a>
            </div>
            <div class="collapse navbar-collapse menu-ui-design" id="navbar-menu">
              <ul class="nav navbar-nav navbar-right" data-in="fadeInDown" data-out="fadeOutUp">
                <li class="scroll active"><a href="#home">Trang chủ</a></li>
                <li class="scroll"><a href="#service">Dịch vụ</a></li>
                <li class="scroll"><a href="#featured-cars">Xe nổi bật</a></li>
                <li class="scroll"><a href="#new-cars">Xe mới</a></li>
                <li class="scroll"><a href="#brand">Thương hiệu</a></li>
                <li class="scroll"><a href="#contact">Liên hệ</a></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
      <div class="clearfix"></div>
    </div>
  </section>


  






<section id="featured-cars" data-total="{{ vehicles|length }}">
  <div class="container"><div class="section-header text-center">
      <h2>Ma<span> trận so sánh cặp cho mỗi tiêu chí </span></h2>
      <p>Chỉnh <span> sửa và tính toán lại AHP</span></p>
    </div>

    <div id="vehicleWarning" class="text-danger text-center mb-3"></div>

    <div class="container my-5">
<form id="matrices-form" method="POST" novalidate>
      {% for crit, info in matrices.items() %}
      <div class="matrix-container" data-crit="{{ crit }}">
        <h4>{{ full_cfg[crit]['display'] }} (Trọng số cũ: {{ info.weights | join(', ') }})</h4>
        <div class="metrics text-sm text-muted">
          <span>λₘₐₓ: <b class="lambda">–</b></span>
          <span>CI: <b class="ci">–</b></span>
          <span>CR: <b class="cr">–</b></span>
          <span>Weights: <b class="weights">–</b></span>
        </div>
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>Phương án</th>
              {% for alt in alternatives %}
                <th>{{ alt }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for i in range(alternatives|length) %}
              <tr>
                <th class="align-middle">{{ alternatives[i] }}</th>
                {% for j in range(alternatives|length) %}
                  <td>
                    {% if j > i %}
                    <div class="mb-3">
                      <input
                        type="number"
                        class="form-control pair-input"
                        data-i="{{ i }}" data-j="{{ j }}"
                        name="matrix_{{ crit }}_{{ i }}_{{ j }}"
                        step="any" min="0.1111" max="9"
                        value="{{ info.original[i][j] | round(4) }}"
                        required
                      >
                      <div class="invalid-feedback">
        Giá trị phải nằm trong khoảng từ 1/9 (~0.1111) đến 9.
      </div>
    </div>
                    {% elif j == i %}
                      <input type="number" readonly class="form-control" value="1.0000">
                    {% else %}
                      {% set rev = 1.0 / info.original[j][i] %}
                      {% set rev = rev < (1.0/9.0) and (1.0/9.0) or rev %}
                      {% set rev = rev > 9.0 and 9.0 or rev %}
                      <input
                        type="number"
                        class="form-control mirror-input"
                        data-i="{{ i }}" data-j="{{ j }}"
                        step="any" min="0.1111" max="9"
                        readonly
                        value="{{ rev | round(4) }}"
                      >
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
    <div class="d-flex justify-content-between mt-4">
      <button
        type="submit"
        formaction="{{ url_for('custom_matrix') }}"
        formmethod="post"
        class="btn btn-primary"
      >
        <i class="fa-solid fa-calculator"></i> Tính lại AHP
      </button>
      <button
        type="submit"
        formaction="{{ url_for('recalc_total') }}"
        formmethod="post"
        class="btn btn-success"
        disabled
      >
        <i class="fa-solid fa-chart-simple"></i> Xem kết quả tổng
      </button>
    </div>
  </form>
</div>
  </div>
</section>


<footer class="bg-dark text-center text-white py-3">
  <small>&copy; 2023 AHP Auto Advisor. All rights reserved.</small>
</footer>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
function computeAHP(M) {
  const n = M.length;
  const colSum = Array(n).fill(0);
  for (let j=0; j<n; j++) for (let i=0; i<n; i++) colSum[j] += M[i][j];
  const norm = M.map(row => row.map((v,j) => v/colSum[j]));
  const w = norm.map(row => row.reduce((a,b)=>a+b,0)/n);
  const weighted = M.map(row => row.reduce((s,v,i)=>s+v*w[i],0));
  const lambda = weighted.reduce((s,v,i)=>s + v/w[i],0)/n;
  const CI = (lambda - n)/(n-1);
  const RI = {1:0,2:0,3:0.58,4:0.9,5:1.12,6:1.24,7:1.32}[n]||1.32;
  return { w, lambda, CI, CR: CI/RI };
}
function updateMatrix(container) {
  const inputs = container.querySelectorAll('.pair-input');
  const n = container.querySelectorAll('tbody tr').length;
  const M = Array.from({length:n},()=>Array(n).fill(1));
  inputs.forEach(inp => {
    const v = parseFloat(inp.value);
    if (!isNaN(v)) {
      const i = +inp.dataset.i, j = +inp.dataset.j;
      M[i][j] = v;
      M[j][i] = 1/v;
      const mirror = container.querySelector(`.mirror-input[data-i=\"${j}\"][data-j=\"${i}\"]`);
      if (mirror) mirror.value = (1/v).toFixed(4);
    }
  });
  const { w, lambda, CI, CR } = computeAHP(M);
  container.querySelector('.lambda').textContent = lambda.toFixed(3);
  container.querySelector('.ci').textContent = CI.toFixed(3);
  container.querySelector('.cr').textContent = CR.toFixed(3);
  container.querySelector('.weights').textContent = w.map(v=>v.toFixed(3)).join(', ');
  return CR < 0.1;
}
function refreshAll() {
  const containers = document.querySelectorAll('.matrix-container');
  let allOk = true;
  containers.forEach(c => { if (!updateMatrix(c)) allOk = false; });
  document.querySelector('button[formaction$=\"recalc_total\"]').disabled = !allOk;
}
// Thêm sự kiện cho các ô nhập liệu
document.querySelectorAll('.pair-input').forEach(inp => {
  inp.addEventListener('input', e => {
    const v = parseFloat(e.target.value);
    // chỉ remove lỗi khi sửa thành đúng
    if (!isNaN(v) && v >= 1/9 && v <= 9) {
      e.target.classList.remove('is-invalid');
      // mirror
      const { i, j } = e.target.dataset;
      const m = document.querySelector(`.mirror-input[data-i="${j}"][data-j="${i}"]`);
      if (m) m.value = (1/v).toFixed(4);
    }
    refreshAll();
  });

  inp.addEventListener('blur', e => {
    clamp(e.target);   // format và clamp
    const v = parseFloat(e.target.value);
    if (isNaN(v) || v < 1/9 || v > 9) {
      e.target.classList.add('is-invalid');
    }
  });
});


// Khởi tạo tính CR và weights lần đầu
refreshAll();

function clamp(el) {
  const min = 1/9, max = 9;
  let val = parseFloat(el.value);
  if (!isNaN(val)) {
    if (val < min) val = min;
    if (val > max) val = max;
    el.value = val.toFixed(4);
  }
}
</script>

		<!--brand strat -->
		<section id="brand"  class="brand">
			<div class="container">
				<div class="brand-area">
					<div class="owl-carousel owl-theme brand-item">
						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br1.png') }}" />
							</a>
						</div><!--/.item-->
						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br2.png') }}" />
							</a>
						</div><!--/.item-->
						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br3.png') }}" />
							</a>
						</div><!--/.item-->
						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br4.png') }}" />
							</a>
						</div><!--/.item-->

						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br5.png') }}" />
							</a>
						</div><!--/.item-->

						<div class="item">
							<a href="#">
								<img src="{{ url_for('static', filename='assets/images/brand/br6.png') }}" />
							</a>
						</div><!--/.item-->
					</div><!--/.owl-carousel-->
				</div><!--/.clients-area-->

			</div><!--/.container-->

		</section><!--/brand-->	
		<!--brand end -->

		<!--blog start -->
		<section id="blog" class="blog"></section><!--/.blog-->
		<!--blog end -->

		<!--contact start-->
		<footer id="contact"  class="contact">
			<div class="container">
				<div class="footer-top">
					<div class="row">
						<div class="col-md-3 col-sm-6">
							<div class="single-footer-widget">
								<div class="footer-logo">
									<a href="index.html">carvilla</a>
								</div>
								<p>
									Ased do eiusm tempor incidi ut labore et dolore magnaian aliqua. Ut enim ad minim veniam.
								</p>
								<div class="footer-contact">
									<p>info@themesine.com</p>
									<p>+1 (885) 2563154554</p>
								</div>
							</div>
						</div>
						<div class="col-md-2 col-sm-6">
							<div class="single-footer-widget">
								<h2>about devloon</h2>
								<ul>
									<li><a href="#">about us</a></li>
									<li><a href="#">career</a></li>
									<li><a href="#">terms <span> of service</span></a></li>
									<li><a href="#">privacy policy</a></li>
								</ul>
							</div>
						</div>
						<div class="col-md-3 col-xs-12">
							<div class="single-footer-widget">
								<h2>top brands</h2>
								<div class="row">
									<div class="col-md-7 col-xs-6">
										<ul>
											<li><a href="#">BMW</a></li>
											<li><a href="#">lamborghini</a></li>
											<li><a href="#">camaro</a></li>
											<li><a href="#">audi</a></li>
											<li><a href="#">infiniti</a></li>
											<li><a href="#">nissan</a></li>
										</ul>
									</div>
									<div class="col-md-5 col-xs-6">
										<ul>
											<li><a href="#">ferrari</a></li>
											<li><a href="#">porsche</a></li>
											<li><a href="#">land rover</a></li>
											<li><a href="#">aston martin</a></li>
											<li><a href="#">mersedes</a></li>
											<li><a href="#">opel</a></li>
										</ul>
									</div>
								</div>
							</div>
						</div>
						<div class="col-md-offset-1 col-md-3 col-sm-6">
							<div class="single-footer-widget">
								<h2>news letter</h2>
								<div class="footer-newsletter">
									<p>
										Subscribe to get latest news  update and informations
									</p>
								</div>
								<div class="hm-foot-email">
									<div class="foot-email-box">
										<input type="text" class="form-control" placeholder="Add Email">
									</div><!--/.foot-email-box-->
									<div class="foot-email-subscribe">
										<span><i class="fa fa-arrow-right"></i></span>
									</div><!--/.foot-email-icon-->
								</div><!--/.hm-foot-email-->
							</div>
						</div>
					</div>
				</div>
				<div class="footer-copyright">
					<div class="row">
						<div class="col-sm-6">
							<p>
								&copy; copyright.designed and developed by <a href="https://www.themesine.com/">themesine</a>.
							</p><!--/p-->
						</div>
						<div class="col-sm-6">
							<div class="footer-social">
								<a href="#"><i class="fa fa-facebook"></i></a>	
								<a href="#"><i class="fa fa-instagram"></i></a>
								<a href="#"><i class="fa fa-linkedin"></i></a>
								<a href="#"><i class="fa fa-pinterest-p"></i></a>
								<a href="#"><i class="fa fa-behance"></i></a>	
							</div>
						</div>
					</div>
				</div><!--/.footer-copyright-->
			</div><!--/.container-->

			<div id="scroll-Top">
				<div class="return-to-top">
					<i class="fa fa-angle-up " id="scroll-top" data-toggle="tooltip" data-placement="top" title="" data-original-title="Back to Top" aria-hidden="true"></i>
				</div>
				
			</div><!--/.scroll-Top-->
			
        </footer>


		
	 <!-- Include JS files -->
   <script src="{{ url_for('static', filename='assets/js/jquery.js') }}"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
   <script src="{{ url_for('static', filename='assets/js/bootstrap.min.js') }}"></script>
   <script src="{{ url_for('static', filename='assets/js/bootsnav.js') }}"></script>
   <script src="{{ url_for('static', filename='assets/js/owl.carousel.min.js') }}"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
   <script src="{{ url_for('static', filename='assets/js/custom.js') }}"></script>
    
  <!-- JS Libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    </body>
	
</html>